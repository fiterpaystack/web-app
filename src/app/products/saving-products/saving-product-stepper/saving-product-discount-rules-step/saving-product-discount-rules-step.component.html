<div class="layout-row-wrap gap-2px responsive-column">
  <mat-form-field class="flex-48">
    <mat-label>{{ 'labels.inputs.Discount Rule' | translate }}</mat-label>
    <mat-select #discountRule>
      <mat-option *ngFor="let rule of filteredAvailableRules" [value]="rule">
        {{ rule.name }} ({{ rule.ruleType }})
      </mat-option>
    </mat-select>
  </mat-form-field>

  <div class="flex-48 align-center">
    <button
      type="button"
      mat-raised-button
      color="primary"
      (click)="addDiscountRule(discountRule)"
      [disabled]="!discountRule.value"
    >
      <fa-icon icon="plus" class="m-r-10"></fa-icon>
      {{ 'labels.buttons.Add' | translate }}
    </button>
  </div>

  <div class="discount-rules-wrapper mat-elevation-z1 flex-98" *ngIf="discountRulesDataSource.length > 0">
    <table class="discount-rules-table" mat-table [dataSource]="discountRulesDataSource">
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Name' | translate }}</th>
        <td mat-cell *matCellDef="let rule">{{ rule.name }}</td>
      </ng-container>

      <ng-container matColumnDef="ruleType">
        <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Type' | translate }}</th>
        <td mat-cell *matCellDef="let rule">
          {{
            rule.ruleType === 'PERCENTAGE'
              ? ('labels.inputs.Percentage' | translate)
              : ('labels.inputs.Flat Amount' | translate)
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="ruleParameters">
        <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Parameters' | translate }}</th>
        <td mat-cell *matCellDef="let rule" class="col-rule-parameters">
          <pre class="rule-parameters">{{ rule.ruleParametersJson || 'No parameters' }}</pre>
        </td>
      </ng-container>

      <ng-container matColumnDef="rulePriority">
        <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Rule Priority' | translate }}</th>
        <td mat-cell *matCellDef="let rule">{{ rule.rulePriority ?? rule.priority ?? 'â€”' }}</td>
      </ng-container>

      <ng-container matColumnDef="assignmentPriority">
        <th mat-header-cell *matHeaderCellDef>Assignment Priority</th>
        <td mat-cell *matCellDef="let rule">
          <mat-form-field class="priority-field">
            <mat-label>{{ 'labels.inputs.Priority' | translate }}</mat-label>
            <input
              matInput
              type="number"
              min="0"
              max="999"
              [value]="rule.assignmentPriority || 0"
              (input)="updateAssignmentPriority(rule, $event)"
            />
            <mat-hint>0-999</mat-hint>
          </mat-form-field>
        </td>
      </ng-container>

      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Action' | translate }}</th>
        <td mat-cell *matCellDef="let rule">
          <button
            mat-icon-button
            color="warn"
            (click)="deleteDiscountRule(rule)"
            matTooltip="{{ 'tooltips.Remove this discount rule' | translate }}"
          >
            <fa-icon icon="trash"></fa-icon>
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>

  <div *ngIf="discountPriorityInvalid" class="discount-error">
    <p class="discount-error-text">{{ discountValidationMessage }}</p>
  </div>

  <!-- Discount Policy only when there are multiple rules -->
  <div class="policy-configuration m-t-20" [formGroup]="policyForm" *ngIf="discountRulesDataSource.length > 1">
    <h5>{{ 'labels.heading.Discount Policy' | translate }}</h5>

    <mat-checkbox formControlName="allRulesRequired"> All rules must be applicable (AND logic) </mat-checkbox>
    <p class="policy-hint block-hint">Require every assigned rule before any discount is granted.</p>

    <mat-form-field class="flex-40 m-t-10">
      <mat-label>Combination Strategy</mat-label>
      <mat-select formControlName="combinationStrategy">
        <mat-option *ngFor="let option of discountCombinationOptions" [value]="option.value">
          {{ option.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- Stepper Navigation -->
  <div class="flex-100 layout-row justify-content-end">
    <button mat-button matStepperPrevious>
      <fa-icon icon="arrow-left" class="m-r-10"></fa-icon>
      {{ 'labels.buttons.Previous' | translate }}
    </button>
    <button mat-raised-button color="primary" matStepperNext>
      {{ 'labels.buttons.Next' | translate }}
      <fa-icon icon="arrow-right" class="m-l-10"></fa-icon>
    </button>
  </div>
</div>
