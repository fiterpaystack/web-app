<div class="layout-row align-end gap-2px responsive-column container m-b-20">
  <button mat-raised-button color="primary" [routerLink]="['edit']" *mifosxHasPermission="'UPDATE_CHARGE'">
    <fa-icon icon="edit" class="m-r-10"></fa-icon>
    {{ 'labels.heading.Edit' | translate }}
  </button>
  <button mat-raised-button color="warn" (click)="deleteCharge()" *mifosxHasPermission="'DELETE_CHARGE'">
    <fa-icon icon="trash" class="m-r-10"></fa-icon>
    {{ 'labels.heading.Delete' | translate }}
  </button>
</div>

<div class="container">
  <mat-card>
    <mat-card-content>
      <div class="layout-row-wrap">
        <div class="flex-50 mat-body-strong">
          {{ 'labels.inputs.Charge Name' | translate }}
        </div>

        <div class="flex-50">
          {{ chargeData.name }}
        </div>

        <div class="flex-50 mat-body-strong">
          {{ 'labels.inputs.Charge Applies To' | translate }}
        </div>

        <div class="flex-50">
          {{ chargeData.chargeAppliesTo.value | translateKey: 'catalogs' }}
        </div>

        <div class="flex-50 mat-body-strong">
          {{ 'labels.inputs.Penalty' | translate }}
        </div>

        <div class="flex-50">
          {{ chargeData.penalty === true | yesNo }}
        </div>

        <div class="flex-50 mat-body-strong">
          {{ 'labels.inputs.Currency' | translate }}
        </div>

        <div class="flex-50">
          {{ chargeData.currency.name }}
        </div>

        <div class="flex-50 mat-body-strong">
          {{ 'labels.inputs.Amount' | translate }}
        </div>

        <div class="flex-50">
          {{ chargeData.amount }}
        </div>

        <div class="flex-50 mat-body-strong" *ngIf="minCap">
          {{ 'labels.inputs.Minimum Charge Cap' | translate }}
        </div>

        <div class="flex-50" *ngIf="minCap">
          {{ chargeData.minCap }}
        </div>

        <div class="flex-50 mat-body-strong" *ngIf="maxCap">
          {{ 'labels.inputs.Maximum Charge Cap' | translate }}
        </div>

        <div class="flex-50" *ngIf="maxCap">
          {{ chargeData.maxCap }}
        </div>

        <div class="flex-50 mat-body-strong">
          {{ 'labels.inputs.Charge Time Type' | translate }}
        </div>

        <div class="flex-50">
          {{ chargeData.chargeTimeType.value | translateKey: 'catalogs' }}
        </div>

        <div class="flex-50 mat-body-strong">
          {{ 'labels.inputs.Charge Calculation Type' | translate }}
        </div>

        <div class="flex-50">
          {{ chargeData.chargeCalculationType.value | translateKey: 'catalogs' }}
        </div>

        <div class="flex-50 mat-body-strong">
          {{ 'labels.inputs.Charge Payment Mode' | translate }}
        </div>

        <div class="flex-50">
          {{ chargeData.chargePaymentMode.value | translateKey: 'catalogs' }}
        </div>

        <div class="flex-50 mat-body-strong">
          {{ 'labels.status.Active' | translate }}
        </div>

        <div class="flex-50">
          {{ chargeData.active === true | yesNo }}
        </div>

        <div class="flex-50 mat-body-strong" *ngIf="chargeData.chargeTimeType.id === 9 && chargeData.feeFrequency">
          {{ 'labels.inputs.Add Fee Frequency' | translate }}
        </div>

        <div
          class="flex-50"
          *ngIf="chargeData.chargeTimeType.id === 9 && chargeData.feeFrequency && chargeData.feeFrequency"
        >
          {{ chargeData.feeFrequency.value | translateKey: 'catalogs' }}
        </div>

        <div class="flex-50 mat-body-strong" *ngIf="chargeData.chargeTimeType.id === 9 && chargeData.feeInterval">
          {{ 'labels.inputs.Frequency Interval' | translate }}
        </div>

        <div class="flex-50" *ngIf="chargeData.chargeTimeType.id === 9 && chargeData.feeInterval">
          {{ chargeData.feeInterval }}
        </div>

        <mifosx-gl-account-display
          class="flex-100"
          [accountTitle]="'Income From Charges'"
          *ngIf="chargeData.incomeOrLiabilityAccount"
          [glAccount]="chargeData.incomeOrLiabilityAccount"
          [withTitle]="'50%'"
        >
        </mifosx-gl-account-display>

        <div class="flex-50 mat-body-strong" *ngIf="chargeData.taxGroup">
          {{ 'labels.inputs.Tax Group' | translate }}
        </div>

        <div class="flex-50" *ngIf="chargeData.taxGroup">
          {{ chargeData.taxGroup.name }}
        </div>

        <!-- Fee Split Configuration Section -->
        <div class="flex-50 mat-body-strong" *ngIf="chargeData.enableFeeSplit">
          {{ 'labels.inputs.Fee Split Configuration' | translate }}
        </div>

        <div class="flex-50" *ngIf="chargeData.enableFeeSplit">
          <div *ngIf="loadingSplits" class="loading-spinner">
            <mat-spinner diameter="20"></mat-spinner>
            {{ 'labels.loading.Fee Splits' | translate }}
          </div>
          <div *ngIf="!loadingSplits && feeSplits.length > 0" class="fee-splits-summary">
            <div class="fee-split-summary-item">
              <strong>{{ 'labels.inputs.Total Splits' | translate }}:</strong> {{ feeSplits.length }}
            </div>
            <div class="fee-split-summary-item" *ngIf="getTotalPercentage() > 0">
              <strong>{{ 'labels.inputs.Total Percentage' | translate }}:</strong> {{ getTotalPercentage() }}%
            </div>
            <div class="fee-split-summary-item" *ngIf="getTotalFlatAmount() > 0">
              <strong>{{ 'labels.inputs.Total Flat Amount' | translate }}:</strong>
              {{ getTotalFlatAmount() | currency: chargeData.currency.code : 'symbol-narrow' : '1.2-2' }}
            </div>
          </div>
          <div *ngIf="!loadingSplits && feeSplits.length === 0" class="no-splits">
            {{ 'labels.messages.No Fee Splits Configured' | translate }}
          </div>
        </div>

        <!-- Discount Rules Section -->
        <div
          class="flex-50 mat-body-strong"
          *ngIf="chargeData.chargeAppliesTo.id === 2 && chargeData.additionalAttributes?.enableDiscountEngine"
        >
          {{ 'labels.inputs.Discount Engine Configuration' | translate }}
        </div>

        <div
          class="flex-50"
          *ngIf="chargeData.chargeAppliesTo.id === 2 && chargeData.additionalAttributes?.enableDiscountEngine"
        >
          <div class="discount-rules-summary">
            <div class="discount-rule-summary-item">
              <strong>{{ 'labels.inputs.Total Discount Rules' | translate }}:</strong>
              {{ chargeData.additionalAttributes?.discountRules?.length || 0 }}
            </div>
          </div>
        </div>
      </div>

      <!-- Discount Rules Details Table -->
      <div
        *ngIf="chargeData.chargeAppliesTo.id === 2 && chargeData.additionalAttributes?.discountRules?.length"
        class="discount-rules-details m-t-20"
      >
        <h3>{{ 'labels.inputs.Discount Rules Details' | translate }}</h3>
        <div class="mat-elevation-z8">
          <table mat-table [dataSource]="chargeData.additionalAttributes.discountRules" class="discount-rules-table">
            <ng-container matColumnDef="name">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Name' | translate }}</th>
              <td mat-cell *matCellDef="let rule" class="col-name" [matTooltip]="rule.ruleName || rule.name">
                {{ rule.ruleName || rule.name }}
              </td>
            </ng-container>

            <ng-container matColumnDef="ruleType">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Rule Type' | translate }}</th>
              <td mat-cell *matCellDef="let rule" class="col-rule-type">
                {{ rule.ruleType }}
              </td>
            </ng-container>

            <ng-container matColumnDef="ruleParameters">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Rule Parameters' | translate }}</th>
              <td mat-cell *matCellDef="let rule" class="col-rule-parameters">
                {{ formatRuleParameters(rule.ruleParametersJson) }}
              </td>
            </ng-container>

            <ng-container matColumnDef="priority">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Priority' | translate }}</th>
              <td mat-cell *matCellDef="let rule" class="col-priority">
                {{ rule.rulePriority }}
              </td>
            </ng-container>

            <ng-container matColumnDef="active">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.status.Active' | translate }}</th>
              <td mat-cell *matCellDef="let rule" class="col-active">
                {{ rule.active === true | yesNo }}
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['name', 'ruleType', 'ruleParameters', 'priority', 'active']"></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: ['name', 'ruleType', 'ruleParameters', 'priority', 'active']"
            ></tr>
          </table>
        </div>
      </div>

      <!-- Fee Split Details Table -->
      <div *ngIf="chargeData.enableFeeSplit && feeSplits.length > 0" class="fee-splits-details m-t-20">
        <h3>{{ 'labels.inputs.Fee Split Details' | translate }}</h3>
        <div class="mat-elevation-z8">
          <table mat-table [dataSource]="feeSplits" class="fee-splits-table">
            <ng-container matColumnDef="stakeholder">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Stakeholder' | translate }}</th>
              <td mat-cell *matCellDef="let split">{{ split.fund?.name || 'Fund ' + split.fund?.id }}</td>
            </ng-container>

            <ng-container matColumnDef="splitType">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Split Type' | translate }}</th>
              <td mat-cell *matCellDef="let split">
                {{
                  split.splitType === 'PERCENTAGE'
                    ? ('labels.inputs.Percentage' | translate)
                    : ('labels.inputs.Flat Amount' | translate)
                }}
              </td>
            </ng-container>

            <ng-container matColumnDef="splitValue">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Split Value' | translate }}</th>
              <td mat-cell *matCellDef="let split">
                {{ split.splitValue }}{{ split.splitType === 'PERCENTAGE' ? '%' : '' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="glAccount">
              <th mat-header-cell *matHeaderCellDef>{{ 'GL Account Name or Code Name or Code' | translate }}</th>
              <td mat-cell *matCellDef="let split">
                {{ split.glAccount?.name || 'Account ' + split.glAccount?.id }}
                <span *ngIf="split.glAccount?.glCode" class="gl-code">({{ split.glAccount.glCode }})</span>
              </td>
            </ng-container>

            <ng-container matColumnDef="active">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.status.Active' | translate }}</th>
              <td mat-cell *matCellDef="let split">
                {{ split.active === true | yesNo }}
              </td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="['stakeholder', 'splitType', 'splitValue', 'glAccount', 'active']"
            ></tr>
            <tr
              mat-row
              *matRowDef="let row; columns: ['stakeholder', 'splitType', 'splitValue', 'glAccount', 'active']"
            ></tr>
          </table>
        </div>
      </div>

      <!-- Fee Split Audit History -->
      <div *ngIf="chargeData.enableFeeSplit && feeSplitAudits.length > 0" class="fee-split-audits m-t-20">
        <h3>{{ 'labels.inputs.Fee Split Audit History' | translate }}</h3>
        <div class="mat-elevation-z8">
          <table mat-table [dataSource]="getFlattenedSplitDetails()" class="fee-split-audits-table">
            <ng-container matColumnDef="transactionId">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Transaction ID' | translate }}</th>
              <td mat-cell *matCellDef="let detail">{{ detail.transactionId }}</td>
            </ng-container>

            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Date' | translate }}</th>
              <td mat-cell *matCellDef="let detail">{{ detail.splitDate | date: 'medium' }}</td>
            </ng-container>

            <ng-container matColumnDef="percentage">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Percentage' | translate }}</th>
              <td mat-cell *matCellDef="let detail">{{ detail.splitPercentage }}%</td>
            </ng-container>

            <ng-container matColumnDef="feeAmount">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Fee Amount' | translate }}</th>
              <td mat-cell *matCellDef="let detail">
                {{ detail.totalFeeAmount | currency: chargeData.currency.code : 'symbol-narrow' : '1.2-2' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="splitAmount">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Split Amount' | translate }}</th>
              <td mat-cell *matCellDef="let detail">
                {{ detail.splitAmount | currency: chargeData.currency.code : 'symbol-narrow' : '1.2-2' }}
              </td>
            </ng-container>

            <ng-container matColumnDef="glAccount">
              <th mat-header-cell *matHeaderCellDef>{{ 'GL Account Name or Code' | translate }}</th>
              <td mat-cell *matCellDef="let detail">{{ detail.glAccountName }}</td>
            </ng-container>

            <ng-container matColumnDef="stakeholder">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Stakeholder' | translate }}</th>
              <td mat-cell *matCellDef="let detail">{{ detail.fundName }}</td>
            </ng-container>

            <ng-container matColumnDef="journalEntry">
              <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Journal Entry' | translate }}</th>
              <td mat-cell *matCellDef="let detail">{{ detail.journalEntryId }}</td>
            </ng-container>

            <tr
              mat-header-row
              *matHeaderRowDef="[
                'transactionId',
                'date',
                'percentage',
                'feeAmount',
                'splitAmount',
                'glAccount',
                'stakeholder',
                'journalEntry'
              ]"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                columns: [
                  'transactionId',
                  'date',
                  'percentage',
                  'feeAmount',
                  'splitAmount',
                  'glAccount',
                  'stakeholder',
                  'journalEntry'
                ]
              "
            ></tr>
          </table>
        </div>
      </div>

      <!-- Split Details Dialog -->
      <ng-template #splitDetailsDialog>
        <div class="split-details-dialog">
          <h2 mat-dialog-title>
            {{ 'labels.inputs.Split Details for Transaction' | translate }} {{ selectedAudit?.transactionId }}
          </h2>
          <mat-dialog-content>
            <div class="split-details-summary">
              <p>
                <strong>{{ 'labels.inputs.Total Fee Amount' | translate }}:</strong>
                {{ selectedAudit?.totalFeeAmount | currency: chargeData.currency.code : 'symbol-narrow' : '1.2-2' }}
              </p>
              <p>
                <strong>{{ 'labels.inputs.Split Date' | translate }}:</strong>
                {{ selectedAudit?.splitDate | date: 'fullDate' }}
              </p>
              <p>
                <strong>{{ 'labels.inputs.Total Splits' | translate }}:</strong>
                {{ selectedAudit?.splitDetails?.length || 0 }}
              </p>
            </div>

            <div class="split-details-table m-t-20">
              <h4>{{ 'labels.inputs.Individual Splits' | translate }}</h4>
              <table mat-table [dataSource]="selectedAudit?.splitDetails || []" class="split-details-table">
                <ng-container matColumnDef="fundName">
                  <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Fund' | translate }}</th>
                  <td mat-cell *matCellDef="let detail">{{ detail.fundName }}</td>
                </ng-container>

                <ng-container matColumnDef="splitAmount">
                  <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Split Amount' | translate }}</th>
                  <td mat-cell *matCellDef="let detail">
                    {{ detail.splitAmount | currency: chargeData.currency.code : 'symbol-narrow' : '1.2-2' }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="splitPercentage">
                  <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Percentage' | translate }}</th>
                  <td mat-cell *matCellDef="let detail">{{ detail.splitPercentage }}%</td>
                </ng-container>

                <ng-container matColumnDef="glAccountName">
                  <th mat-header-cell *matHeaderCellDef>{{ 'GL Account Name or Code' | translate }}</th>
                  <td mat-cell *matCellDef="let detail">{{ detail.glAccountName }}</td>
                </ng-container>

                <ng-container matColumnDef="journalEntryId">
                  <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Journal Entry' | translate }}</th>
                  <td mat-cell *matCellDef="let detail">{{ detail.journalEntryId }}</td>
                </ng-container>

                <tr
                  mat-header-row
                  *matHeaderRowDef="['fundName', 'splitAmount', 'splitPercentage', 'glAccountName', 'journalEntryId']"
                ></tr>
                <tr
                  mat-row
                  *matRowDef="
                    let row;
                    columns: ['fundName', 'splitAmount', 'splitPercentage', 'glAccountName', 'journalEntryId']
                  "
                ></tr>
              </table>
            </div>
          </mat-dialog-content>
          <mat-dialog-actions align="end">
            <button mat-button mat-dialog-close>{{ 'labels.buttons.Close' | translate }}</button>
          </mat-dialog-actions>
        </div>
      </ng-template>

      <div class="layout-row layout-align-center gap-2percent column-on-mobile">
        <button type="button" mat-raised-button color="primary" [routerLink]="['../']">
          {{ 'labels.buttons.Back' | translate }}
        </button>
      </div>
    </mat-card-content>
  </mat-card>
</div>
