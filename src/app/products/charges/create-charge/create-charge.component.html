<div class="container">
  <mat-card>
    <form [formGroup]="chargeForm" (ngSubmit)="submit()">
      <mat-card-content>
        <div class="layout-row-wrap gap-2px responsive-column">
          <mat-form-field class="flex-48">
            <mat-label>{{ 'labels.inputs.Charge Applies To' | translate }}</mat-label>
            <mat-select required formControlName="chargeAppliesTo">
              <mat-option
                *ngFor="let chargeAppliesTo of chargesTemplateData.chargeAppliesToOptions"
                [value]="chargeAppliesTo.id"
              >
                {{ chargeAppliesTo.value | translateKey: 'catalogs' }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="chargeForm.controls.chargeAppliesTo.hasError('required')">
              {{ 'labels.inputs.Charge Applies To' | translate }} {{ 'labels.commons.is' | translate }}
              <strong>{{ 'labels.commons.required' | translate }}</strong>
            </mat-error>
          </mat-form-field>

          <mat-divider [inset]="true"></mat-divider>

          <div
            *ngIf="chargeForm.controls.chargeAppliesTo.value"
            class="layout-row-wrap gap-2percent layout-lt-md-column form-section"
          >
            <mat-form-field class="flex-48">
              <mat-label>{{ 'labels.inputs.Charge Name' | translate }}</mat-label>
              <input matInput required formControlName="name" />
              <mat-error *ngIf="chargeForm.controls.name.hasError('required')">
                {{ 'labels.inputs.Charge Name' | translate }} {{ 'labels.commons.is' | translate }}
                <strong>{{ 'labels.commons.required' | translate }}</strong>
              </mat-error>
            </mat-form-field>

            <mat-form-field class="flex-48">
              <mat-label>{{ 'labels.inputs.Currency' | translate }}</mat-label>
              <mat-select required formControlName="currencyCode">
                <mat-option *ngFor="let currency of chargesTemplateData.currencyOptions" [value]="currency.code">
                  {{ currency.name }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="chargeForm.controls.currencyCode.hasError('required')">
                {{ 'labels.inputs.Currency' | translate }} {{ 'labels.commons.is' | translate }}
                <strong>{{ 'labels.commons.required' | translate }}</strong>
              </mat-error>
            </mat-form-field>

            <mat-form-field class="flex-48">
              <mat-label>{{ 'labels.inputs.Charge Time Type' | translate }}</mat-label>
              <mat-select required formControlName="chargeTimeType">
                <mat-option *ngFor="let chargeTimeType of chargeTimeTypeData" [value]="chargeTimeType.id">
                  {{ chargeTimeType.value | translateKey: 'catalogs' }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="chargeForm.controls.chargeTimeType.hasError('required')">
                {{ 'labels.inputs.Charge Time Type' | translate }} {{ 'labels.commons.is' | translate }}
                <strong>{{ 'labels.commons.required' | translate }}</strong>
              </mat-error>
            </mat-form-field>

            <mat-form-field class="flex-48">
              <mat-label>{{ 'labels.inputs.Charge Calculation Type' | translate }}</mat-label>
              <mat-select required formControlName="chargeCalculationType">
                <mat-option
                  *ngFor="let chargeCalculationType of filteredChargeCalculationType()"
                  [value]="chargeCalculationType.id"
                >
                  {{ chargeCalculationType.value | translateKey: 'catalogs' }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="chargeForm.controls.chargeCalculationType.hasError('required')">
                {{ 'labels.inputs.Charge Calculation Type' | translate }} {{ 'labels.commons.is' | translate }}
                <strong>{{ 'labels.commons.required' | translate }}</strong>
              </mat-error>
            </mat-form-field>

            <mat-form-field *ngIf="chargeForm.controls.chargeAppliesTo.value === 1" class="flex-48">
              <mat-label>{{ 'labels.inputs.Charge Payment Mode' | translate }}</mat-label>
              <mat-select required formControlName="chargePaymentMode">
                <mat-option
                  *ngFor="let chargePaymentMode of chargesTemplateData.chargePaymetModeOptions"
                  [value]="chargePaymentMode.id"
                >
                  {{ chargePaymentMode.value | translateKey: 'catalogs' }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="chargeForm.controls.chargePaymentMode.hasError('required')">
                {{ 'labels.inputs.Charge Payment Mode' | translate }} {{ 'labels.commons.is' | translate }}
                <strong>{{ 'labels.commons.required' | translate }}</strong>
              </mat-error>
            </mat-form-field>

            <div class="flex-48 add-fee-frequency-wrapper" *ngIf="chargeForm.controls.chargeTimeType.value === 9">
              <mat-checkbox labelPosition="before" formControlName="addFeeFrequency">
                {{ 'labels.inputs.Add Fee Frequency' | translate }}
              </mat-checkbox>
            </div>

            <mat-form-field
              *ngIf="chargeForm.controls.chargeTimeType.value === 9 && chargeForm.controls.addFeeFrequency.value"
              class="flex-48"
            >
              <mat-label>{{ 'labels.inputs.Frequency Interval' | translate }}</mat-label>
              <input matInput required formControlName="feeInterval" />
              <mat-error *ngIf="chargeForm.controls.feeInterval.hasError('required')">
                {{ 'labels.inputs.Frequency Interval' | translate }} {{ 'labels.commons.is' | translate }}
                <strong>{{ 'labels.commons.required' | translate }}</strong>
              </mat-error>
              <mat-error *ngIf="chargeForm.controls.feeInterval.hasError('pattern')">
                {{ 'labels.inputs.Frequency Interval' | translate }}
                <strong>{{ 'labels.commons.must be a positive integer' | translate }}</strong>
              </mat-error>
            </mat-form-field>

            <mat-form-field
              *ngIf="chargeForm.controls.chargeTimeType.value === 9 && chargeForm.controls.addFeeFrequency.value"
              class="flex-48"
            >
              <mat-label>{{ 'labels.inputs.Charge Frequency' | translate }}</mat-label>
              <mat-select required formControlName="feeFrequency">
                <mat-option
                  *ngFor="let feeFrequency of chargesTemplateData.feeFrequencyOptions"
                  [value]="feeFrequency.id"
                >
                  {{ feeFrequency.value | translateKey: 'catalogs' }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="chargeForm.controls.feeFrequency.hasError('required')">
                {{ 'labels.inputs.Charge Frequency' | translate }} {{ 'labels.commons.is' | translate }}
                <strong>{{ 'labels.commons.required' | translate }}</strong>
              </mat-error>
            </mat-form-field>

            <mat-form-field
              (click)="dueDatePicker.open()"
              *ngIf="chargeForm.controls.chargeTimeType.value === 6 || chargeForm.controls.chargeTimeType.value === 7"
              class="flex-48"
            >
              <mat-label>{{ 'labels.inputs.Due Date' | translate }}</mat-label>
              <input
                matInput
                [min]="minDate"
                [max]="maxDate"
                [matDatepicker]="dueDatePicker"
                required
                formControlName="feeOnMonthDay"
              />
              <mat-datepicker-toggle matSuffix [for]="dueDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #dueDatePicker></mat-datepicker>
              <mat-error *ngIf="chargeForm.controls.feeOnMonthDay.hasError('required')">
                {{ 'labels.inputs.Due Date' | translate }} {{ 'labels.commons.is' | translate }}
                <strong>{{ 'labels.commons.required' | translate }}</strong>
              </mat-error>
            </mat-form-field>

            <mat-form-field
              class="flex-48"
              *ngIf="chargeForm.controls.chargeTimeType.value === 7 || chargeForm.controls.chargeTimeType.value === 11"
            >
              <mat-label>{{ 'labels.inputs.Repeat Every' | translate }} ({{ repeatEveryLabel }})</mat-label>
              <input matInput required formControlName="feeInterval" />
              <mat-error *ngIf="chargeForm.controls.feeInterval.hasError('required')">
                {{ 'labels.inputs.Repeat Every' | translate }} ({{ repeatEveryLabel }})
                {{ 'labels.commons.is' | translate }} <strong>{{ 'labels.commons.required' | translate }}</strong>
              </mat-error>
              <mat-error
                *ngIf="
                  (chargeForm.controls.feeInterval.hasError('min') ||
                    chargeForm.controls.feeInterval.hasError('max')) &&
                  !chargeForm.controls.feeInterval.hasError('pattern')
                "
              >
                {{ 'labels.inputs.Repeat Every' | translate }} ({{ repeatEveryLabel }})
                <strong>{{ 'labels.commons.must be between 1 and 12' | translate }}</strong>
              </mat-error>
              <mat-error *ngIf="chargeForm.controls.feeInterval.hasError('pattern')">
                {{ 'labels.inputs.Repeat Every' | translate }} ({{ repeatEveryLabel }})
                <strong>{{ 'labels.commons.must be a positive integer' | translate }}</strong>
              </mat-error>
            </mat-form-field>

            <div *ngIf="!isChartSelected">
              <mat-form-field class="flex-48">
                <mat-label>{{ 'labels.inputs.Amount' | translate }}</mat-label>
                <input matInput formControlName="amount" />
                <mat-error *ngIf="chargeForm.controls.amount.hasError('required')">
                  {{ 'labels.inputs.Amount' | translate }} {{ 'labels.commons.is' | translate }}
                  <strong>{{ 'labels.commons.required' | translate }}</strong>
                </mat-error>
              </mat-form-field>
            </div>

            <!--
   * minCap and maxCap only allowed for loan ,shares and savings entitites
   * In Loan case: Only for the "charge calculation type" set as "%amount", "% loan amount+interest", "%interest",and"%disbursement amount".
   * In saving case: Only for 1. charge time type is "withdrawlfee" or "savings no activity fee" with charge calculation type as "% amount"
   * In shares case: Only for charge time type: SHARE_PURCHASE and SHARE_REDEEM and with charge calculation type as % amount only
  -->
            <mat-form-field class="flex-48" *ngIf="showMinMaxCap()">
              <mat-label>{{ 'labels.inputs.Minimum Charge Cap' | translate }}</mat-label>
              <input matInput autofocus formControlName="minCap" mifosxValidateOnFocus />
              <mat-error *ngIf="chargeForm.controls.minCap.hasError('maxValue')">
                {{ 'errors.validation.msg.loanproduct.minimumGap.not.greater.than.specified.number' | translate }} ({{
                  chargeForm.controls.maxCap.value
                }})
              </mat-error>
            </mat-form-field>

            <mat-form-field class="flex-48" *ngIf="showMinMaxCap()">
              <mat-label>{{ 'labels.inputs.Maximum Charge Cap' | translate }}</mat-label>
              <input matInput autofocus formControlName="maxCap" mifosxValidateOnFocus />

              <mat-error *ngIf="chargeForm.controls.maxCap.hasError('minValue')">
                {{ 'errors.validation.msg.loanproduct.maximumGap.not.greater.than.specified.number' | translate }} ({{
                  chargeForm.controls.minCap.value
                }})
              </mat-error>
            </mat-form-field>

            <mifosx-gl-account-selector
              class="flex-48"
              *ngIf="chargeForm.controls.chargeAppliesTo.value === 3"
              [inputFormControl]="chargeForm.controls.incomeAccountId"
              [glAccountList]="incomeAndLiabilityAccountData"
              [inputLabel]="'Income from Charge'"
            >
            </mifosx-gl-account-selector>

            <mat-form-field class="flex-48">
              <mat-label>{{ 'labels.inputs.Tax Group' | translate }}</mat-label>
              <mat-select formControlName="taxGroupId">
                <mat-option *ngFor="let taxGroup of chargesTemplateData.taxGroupOptions" [value]="taxGroup.id">
                  {{ taxGroup.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <div class="flex-48 layout-row gap-2percent layout-lt-md-column">
              <div class="flex-50 active-wrapper">
                <mat-checkbox labelPosition="before" formControlName="active">
                  {{ 'labels.status.Active' | translate }}
                </mat-checkbox>
              </div>

              <div class="flex-50 penalty-wrapper">
                <mat-checkbox labelPosition="before" formControlName="penalty">
                  {{ 'labels.commons.Is' | translate }} {{ 'labels.inputs.Penalty' | translate }}
                </mat-checkbox>
              </div>
            </div>
          </div>
        </div>

        <!-- ✅ Enable Slabs Checkbox (only for Withdrawal Fee = id 5) -->
        <div class="flex-48" *ngIf="chargeForm.get('chargeTimeType').value === 5">
          <mat-checkbox formControlName="enableSlabs">Enable Slabs</mat-checkbox>
        </div>

        <!-- ✅ Slabs Table -->
        <div class="flex-48" *ngIf="chargeForm.get('enableSlabs').value" formArrayName="chartSlabs">
          <table mat-table [dataSource]="dataSource" class="mat-elevation-z8" *ngIf="chartSlabs.length > 0">
            <!-- From Amount -->
            <ng-container matColumnDef="fromAmount">
              <th mat-header-cell *matHeaderCellDef>From Amount</th>
              <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                <input matInput formControlName="fromAmount" placeholder="From Amount" />
              </td>
            </ng-container>

            <!-- To Amount -->
            <ng-container matColumnDef="toAmount">
              <th mat-header-cell *matHeaderCellDef>To Amount</th>
              <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                <input matInput formControlName="toAmount" placeholder="To Amount" />
              </td>
            </ng-container>

            <!-- Value -->
            <ng-container matColumnDef="value">
              <th mat-header-cell *matHeaderCellDef>Value</th>
              <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                <input matInput formControlName="value" placeholder="Value" />
              </td>
            </ng-container>

            <!-- Actions -->
            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Actions</th>
              <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
                <button mat-icon-button color="warn" type="button" (click)="removeSlab(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <!-- Header & Row -->
            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
          </table>

          <button mat-raised-button color="primary" type="button" (click)="addSlab()">Add Slab</button>
        </div>
        <!-- Fee Split Configuration Section -->
        <div *ngIf="chargeForm.controls.chargeAppliesTo.value" class="form-section">
          <mat-divider class="m-b-20"></mat-divider>
          <h4>{{ 'labels.heading.Fee Split Configuration' | translate }}</h4>

          <div class="layout-row-wrap gap-2percent layout-lt-md-column">
            <div class="flex-48">
              <mat-checkbox labelPosition="before" formControlName="enableFeeSplit">
                {{ 'labels.inputs.Enable Fee Split' | translate }}
              </mat-checkbox>
            </div>
          </div>

          <div *ngIf="chargeForm.controls.enableFeeSplit.value" class="fee-split-config m-t-20">
            <div formArrayName="stakeholderSplits">
              <div
                *ngFor="let split of stakeholderSplits.controls; let i = index"
                [formGroupName]="i"
                class="split-row layout-row-wrap gap-2percent m-b-10"
              >
                <mat-form-field class="flex-30">
                  <mat-label>{{ 'labels.inputs.Stakeholder' | translate }}</mat-label>
                  <mat-select formControlName="fundId" required>
                    <mat-option *ngFor="let fund of availableFunds" [value]="fund.id">
                      {{ fund.name }}
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="stakeholderSplits.at(i).get('fundId')?.hasError('required')">
                    {{ 'labels.inputs.Stakeholder' | translate }} {{ 'labels.commons.is' | translate }}
                    <strong>{{ 'labels.commons.required' | translate }}</strong>
                  </mat-error>
                </mat-form-field>

                <mat-form-field class="flex-20">
                  <mat-label>{{ 'labels.inputs.Split Type' | translate }}</mat-label>
                  <mat-select formControlName="splitType" required>
                    <mat-option value="PERCENTAGE">{{ 'labels.inputs.Percentage' | translate }}</mat-option>
                    <mat-option value="FLAT_AMOUNT">{{ 'labels.inputs.Flat Amount' | translate }}</mat-option>
                  </mat-select>
                  <mat-error *ngIf="stakeholderSplits.at(i).get('splitType')?.hasError('required')">
                    {{ 'labels.inputs.Split Type' | translate }} {{ 'labels.commons.is' | translate }}
                    <strong>{{ 'labels.commons.required' | translate }}</strong>
                  </mat-error>
                </mat-form-field>

                <mat-form-field class="flex-20">
                  <mat-label>{{ 'labels.inputs.Split Value' | translate }}</mat-label>
                  <input matInput type="number" formControlName="splitValue" required />
                  <mat-error *ngIf="stakeholderSplits.at(i).get('splitValue')?.hasError('required')">
                    {{ 'labels.inputs.Split Value' | translate }} {{ 'labels.commons.is' | translate }}
                    <strong>{{ 'labels.commons.required' | translate }}</strong>
                  </mat-error>
                </mat-form-field>

                <mat-form-field class="flex-25">
                  <mat-label>{{ 'GL Account Name or Code Name or Code' | translate }}</mat-label>
                  <mat-select formControlName="glAccountId" required>
                    <mat-option *ngFor="let account of glAccounts" [value]="account.id">
                      {{ account.name }} ({{ account.glCode }})
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="stakeholderSplits.at(i).get('glAccountId')?.hasError('required')">
                    {{ 'GL Account Name or Code Name or Code' | translate }} {{ 'labels.commons.is' | translate }}
                    <strong>{{ 'labels.commons.required' | translate }}</strong>
                  </mat-error>
                </mat-form-field>

                <button mat-icon-button type="button" (click)="removeStakeholderSplit(i)" class="m-t-10">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>

            <button mat-raised-button type="button" (click)="addStakeholderSplit()" class="m-t-10">
              <!-- <mat-icon>add</mat-icon> -->
              {{ 'labels.buttons.Add Stakeholder' | translate }}
            </button>

            <div *ngIf="chargeForm.hasError('totalPercentageExceeded')" class="m-t-10">
              <mat-error>{{ 'labels.errors.Total percentage splits cannot exceed 100%' | translate }}</mat-error>
            </div>
          </div>
        </div>

        <!-- Discount Rules Assignment Section -->
        <div *ngIf="chargeForm.controls.chargeAppliesTo.value === 2" class="form-section">
          <mat-divider class="m-b-20"></mat-divider>
          <h4>{{ 'labels.heading.Discount Rules Assignment' | translate }}</h4>

          <div class="layout-row-wrap gap-2percent layout-lt-md-column">
            <mat-form-field class="flex-48">
              <mat-label>{{ 'labels.inputs.Discount Rule' | translate }}</mat-label>
              <mat-select #discountRule>
                <mat-option *ngFor="let rule of filteredAvailableRules" [value]="rule">
                  {{ rule.name }} ({{ rule.ruleType }})
                </mat-option>
              </mat-select>
            </mat-form-field>

            <div class="flex-48 align-center">
              <button
                type="button"
                mat-raised-button
                color="primary"
                (click)="addDiscountRule(discountRule)"
                [disabled]="!discountRule.value"
              >
                <mat-icon>add</mat-icon>
                {{ 'labels.buttons.Add' | translate }}
              </button>
            </div>
          </div>

          <!-- Discount Rules Table -->
          <div *ngIf="selectedDiscountRules.length > 0" class="m-t-20">
            <h5>{{ 'labels.heading.Selected Discount Rules' | translate }}</h5>
            <table mat-table [dataSource]="selectedDiscountRules" class="discount-rules-table mat-elevation-z1">
              <ng-container matColumnDef="name">
                <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Name' | translate }}</th>
                <td mat-cell *matCellDef="let rule" class="col-name" [matTooltip]="rule.name">
                  {{ rule.name }}
                </td>
              </ng-container>

              <ng-container matColumnDef="ruleType">
                <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Rule Type' | translate }}</th>
                <td mat-cell *matCellDef="let rule" class="col-rule-type">
                  {{ rule.ruleType }}
                </td>
              </ng-container>

              <ng-container matColumnDef="ruleParameters">
                <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Rule Parameters' | translate }}</th>
                <td mat-cell *matCellDef="let rule" class="col-rule-parameters">
                  {{ formatRuleParameters(rule.ruleParametersJson) }}
                </td>
              </ng-container>

              <ng-container matColumnDef="priority">
                <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Priority' | translate }}</th>
                <td mat-cell *matCellDef="let rule" class="col-priority">
                  {{ rule.rulePriority }}
                </td>
              </ng-container>

              <ng-container matColumnDef="action">
                <th mat-header-cell *matHeaderCellDef>{{ 'labels.inputs.Action' | translate }}</th>
                <td mat-cell *matCellDef="let rule; let i = index">
                  <button
                    mat-icon-button
                    color="warn"
                    (click)="removeDiscountRule(i)"
                    matTooltip="{{ 'tooltips.Remove this discount rule' | translate }}"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="['name', 'ruleType', 'ruleParameters', 'priority', 'action']"></tr>
              <tr
                mat-row
                *matRowDef="let row; columns: ['name', 'ruleType', 'ruleParameters', 'priority', 'action']"
              ></tr>
            </table>
          </div>
        </div>
      </mat-card-content>

      <mat-card-actions class="layout-row align-center gap-5px responsive-column">
        <button type="button" mat-raised-button [routerLink]="['../']" [disabled]="loading">
          {{ 'labels.buttons.Cancel' | translate }}
        </button>
        <button
          mat-raised-button
          color="primary"
          [disabled]="!chargeForm.valid || loading"
          *mifosxHasPermission="'CREATE_CHARGE'"
        >
          <span *ngIf="loading" class="loading-spinner">
            <mat-spinner diameter="20"></mat-spinner>
            {{ 'labels.buttons.Creating' | translate }}...
          </span>
          <span *ngIf="!loading">
            {{ 'labels.buttons.Submit' | translate }}
          </span>
        </button>
      </mat-card-actions>
    </form>
  </mat-card>
</div>
